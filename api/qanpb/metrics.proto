syntax = "proto3";

package qan;

// This option is used to set the default error response for all Swagger APIs generated from this file.
// See also header.json.
// It has to be copy&pasted into each file.
option (grpc.gateway.protoc_gen_swagger.options.openapiv2_swagger) = {
  responses: {
    key: "default"
    value: {
      description: "An error response."
      schema: {
        json_schema: {
          ref: "#/definitions/qanpbErrorResponse"
        }
      }
    }
  }
};
option go_package = "qanpb";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-swagger/options/annotations.proto";

// Metrics serves agregated metrics filtered by given dimention value and period.
service Metrics {
  // GetMetrics gets map of metrics for specific filtering.
  rpc GetMetrics(MetricsRequest) returns (MetricsReply) {
    option (google.api.http) = {
      post: "/v1/qan/Metrics/Get"
      body: "*"
    };
  }
}

// MetricsRequest defines filtering of metrics for specific value of dimention (ex.: host=hostname1 or queryid=1D410B4BE5060972.
message MetricsRequest {
  google.protobuf.Timestamp period_start_from = 1;
  google.protobuf.Timestamp period_start_to = 2;
  string filter_by = 3; // dimention: queryid | host ...
  string group_by = 4; // one of dimention
  repeated MapFieldEntry labels = 5;
  repeated string include_only_fields = 6;
}

// MapFieldEntry allows to pass labels/dimentions in form like {"d_server": ["db1", "db2"...]}.
message MapFieldEntry {
  string key = 1;
  repeated string value = 2;
}

// MetricsReply defines metrics for specific value of dimention (ex.: host=hostname1 or queryid=1D410B4BE5060972.
message MetricsReply {
  map<string, MetricValues> metrics = 3;
}

// MetricValues is statistics of specific metric.
message MetricValues {
  float rate = 1;
  float cnt = 2;
  float sum = 3;
  float min = 4;
  float max = 5;
  float avg = 6;
  float p99 = 7;
  float p_total = 8;
}
