default: help

help:                           ## Display this help message.
	@echo "Please use \`make <target>\` where <target> is one of:"
	@grep '^[a-zA-Z]' $(MAKEFILE_LIST) | \
		awk -F ':.*?## ' 'NF==2 {printf "  %-26s%s\n", $$1, $$2}'
		

gen:                  ## Generate all.
	make gen-api
	make gen-alertmanager
	make clean_swagger


gen-api:              ## Generate API definitions.
#	# generated by descriptors target
	../bin/buf breaking --against descriptor.bin pmm

	../bin/buf generate -v pmm

	for API in pmm/agentlocalpb pmm/serverpb pmm/inventorypb pmm/managementpb pmm/managementpb/dbaas pmm/managementpb/ia pmm/managementpb/alerting pmm/managementpb/backup pmm/managementpb/azure pmm/managementpb/role pmm/qanpb pmm/platformpb pmm/userpb ; do \
		set -x ; \
		../bin/swagger mixin $$API/json/header.json $$API/*.swagger.json --output=$$API/json/$$(basename $$API).json --keep-spec-order; \
		../bin/swagger flatten --with-flatten=expand --with-flatten=remove-unused $$API/json/$$(basename $$API).json --output=$$API/json/$$(basename $$API).json ; \
		../bin/swagger validate $$API/json/$$(basename $$API).json ; \
		../bin/swagger generate client --with-flatten=expand --with-flatten=remove-unused --spec=$$API/json/$$(basename $$API).json --target=$$API/json \
			--additional-initialism=aws \
			--additional-initialism=db \
			--additional-initialism=ok \
			--additional-initialism=pmm \
			--additional-initialism=psmdb \
			--additional-initialism=pxc \
			--additional-initialism=pt \
			--additional-initialism=qan \
			--additional-initialism=rds \
			--additional-initialism=sql \
			--additional-initialism=ha ; \
	done

	# generate public API spec, omit agentlocalpb (always private),
	# and managementpb/dbaas, managementpb/ia, managementpb/azure, managementpb/role and qanpb (not v1 yet)
	../bin/swagger mixin --output=pmm/swagger/swagger.json \
		pmm/swagger/header.json \
		pmm/serverpb/json/serverpb.json \
		pmm/userpb/json/userpb.json \
		pmm/inventorypb/json/inventorypb.json \
		pmm/managementpb/json/managementpb.json \
        pmm/managementpb/backup/json/backup.json \
        pmm/managementpb/alerting/json/alerting.json
	../bin/swagger validate pmm/swagger/swagger.json

	../bin/swagger-order --output=pmm/swagger/swagger.json pmm/swagger/swagger.json

	# generate API spec with all PMM Server APIs (omit agentlocalpb)
	../bin/swagger mixin --output=pmm/swagger/swagger-dev.json \
		pmm/swagger/header-dev.json \
		pmm/serverpb/json/serverpb.json \
		pmm/userpb/json/userpb.json \
		pmm/inventorypb/json/inventorypb.json \
		pmm/managementpb/json/managementpb.json \
		pmm/managementpb/dbaas/json/dbaas.json \
		pmm/managementpb/ia/json/ia.json \
		pmm/managementpb/alerting/json/alerting.json \
		pmm/managementpb/backup/json/backup.json \
		pmm/managementpb/azure/json/azure.json \
		pmm/managementpb/role/json/role.json \
		pmm/qanpb/json/qanpb.json \
		pmm/platformpb/json/platformpb.json
	../bin/swagger validate pmm/swagger/swagger-dev.json

	../bin/swagger-order --output=pmm/swagger/swagger-dev.json pmm/swagger/swagger-dev.json

gen-alertmanager:     # Generate Alertmanager client.
	../bin/swagger generate client --model-package=ammodels --client-package=amclient --spec=alertmanager/openapi.yaml --target=alertmanager

	go install -v ./alertmanager/...

clean_swagger:
	find . -name '*.swagger.json' -print -delete


clean: clean_swagger  ## Remove generated files.
	find . -name '*.pb.go' -print -delete
	find . -name '*.pb.gw.go' -print -delete

	for API in agentlocalpb serverpb inventorypb managementpb managementpb/dbaas managementpb/ia managementpb/alerting managementpb/backup managementpb/role qanpb platformpb ; do \
		rm -fr $$API/json/client $$API/json/models $$API/json/$$(basename $$API).json ; \
	done
	rm -f swagger/swagger.json swagger/swagger-dev.json

serve:                ## Serve API documentation with nginx.
	nginx -p . -c api/pmm/nginx/nginx.conf