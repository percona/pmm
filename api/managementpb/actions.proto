syntax = "proto3";

package management;

// This option is used to set the default error response for all Swagger APIs generated from this file.
// See also header.json.
// It has to be copy&pasted into each file.
option (grpc.gateway.protoc_gen_swagger.options.openapiv2_swagger) = {
  responses: {
    key: "default"
    value: {
      description: "An error response."
      schema: {
        json_schema: {
          ref: "#/definitions/managementpbErrorResponse"
        }
      }
    }
  }
};
option go_package = "managementpb";

import "github.com/mwitkow/go-proto-validators/validator.proto";
import "google/api/annotations.proto";
import "protoc-gen-swagger/options/annotations.proto";

// ActionType represents Action type.
enum ActionType {
  ACTION_TYPE_INVALID = 0;
  PT_SUMMARY = 3;
  PT_MYSQL_SUMMARY = 4;
  MYSQL_EXPLAIN = 8;
  MYSQL_SHOW_CREATE_TABLE = 9;
  MYSQL_SHOW_TABLE_STATUS = 10;
  MYSQL_SHOW_INDEX = 11;
  POSTGRESQL_SHOW_CREATE_TABLE = 12;
  POSTGRESQL_SHOW_INDEX = 13;
}

message GetActionRequest {
  // Unique Action ID.
  string action_id = 1 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
}

message GetActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where this Action is running / was run.
  string pmm_agent_id = 2;
  // Current Action output; may be partial if Action is still running.
  string output = 3;
  // True if Action is finished.
  bool done = 4;
  // Error message if Action failed.
  string error = 5;
}

message StartPTSummaryActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Node ID for this Action.
  string node_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  //
  // TODO pt-summary-specific parameters if we need them.

}

message StartPTSummaryActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartPTMySQLSummaryActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  //
  // TODO pt-mysql-summary-specific parameters if we need them.

}

message StartPTMySQLSummaryActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartMySQLExplainActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // SQL query. Required.
  string query = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if it can't be deduced from the query.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation.
  bool tls_skip_verify = 6;
}

message StartMySQLExplainActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartMySQLExplainJSONActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // SQL query. Required.
  string query = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if it can't be deduced from the query.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation.
  bool tls_skip_verify = 6;
}

message StartMySQLExplainJSONActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartMySQLExplainTraditionalJSONActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // SQL query. Required.
  string query = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if it can't be deduced from the query.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation.
  bool tls_skip_verify = 6;
}

message StartMySQLExplainTraditionalJSONActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartMySQLShowCreateTableActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Table name. Required. May additionally contain a database name.
  string table_name = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if not given in the table_name field.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation.
  bool tls_skip_verify = 6;
}

message StartMySQLShowCreateTableActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartMySQLShowTableStatusActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Table name. Required. May additionally contain a database name.
  string table_name = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if not given in the table_name field.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation.
  bool tls_skip_verify = 6;
}

message StartMySQLShowTableStatusActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartMySQLShowIndexActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Table name. Required. May additionally contain a database name.
  string table_name = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if not given in the table_name field.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation.
  bool tls_skip_verify = 6;
}

message StartMySQLShowIndexActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartPostgreSQLShowCreateTableActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Table name. Required. May additionally contain a database name.
  string table_name = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if not given in the table_name field.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation. Uses sslmode=required instead of verify-full.
  bool tls_skip_verify = 6;
}

message StartPostgreSQLShowCreateTableActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message StartPostgreSQLShowIndexActionRequest {
  // pmm-agent ID where to run this Action.
  string pmm_agent_id = 1;
  // Service ID for this Action. Required.
  string service_id = 2 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Table name. Required. May additionally contain a database name.
  string table_name = 3 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
  // Database name. Required if not given in the table_name field.
  string database = 4;
  // Use TLS for database connections.
  bool tls = 5;
  // Skip TLS certificate and hostname validation. Uses sslmode=required instead of verify-full.
  bool tls_skip_verify = 6;
}

message StartPostgreSQLShowIndexActionResponse {
  // Unique Action ID.
  string action_id = 1;
  // pmm-agent ID where to this Action was started.
  string pmm_agent_id = 2;
}

message CancelActionRequest {
  // Unique Action ID. Required.
  string action_id = 1 [
    (validator.field) = {
      string_not_empty: true
    }
  ];
}

message CancelActionResponse {}

// Actions service provides public Management API methods for Actions.
service Actions {
  // GetAction gets an result of given Action.
  rpc GetAction(GetActionRequest) returns (GetActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/Get"
      body: "*"
    };
  }
  // StartPTSummaryAction starts pt-summary Action.
  rpc StartPTSummaryAction(StartPTSummaryActionRequest) returns (StartPTSummaryActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartPTSummary"
      body: "*"
    };
  }
  // StartPTMySQLSummaryAction starts pt-mysql-summary Action.
  rpc StartPTMySQLSummaryAction(StartPTMySQLSummaryActionRequest) returns (StartPTMySQLSummaryActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartPTMySQLSummary"
      body: "*"
    };
  }
  // StartMySQLExplainAction starts MySQL EXPLAIN Action with traditional output.
  rpc StartMySQLExplainAction(StartMySQLExplainActionRequest) returns (StartMySQLExplainActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartMySQLExplain"
      body: "*"
    };
  }
  // StartMySQLExplainJSONAction starts MySQL EXPLAIN Action with JSON output.
  rpc StartMySQLExplainJSONAction(StartMySQLExplainJSONActionRequest) returns (StartMySQLExplainJSONActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartMySQLExplainJSON"
      body: "*"
    };
  }
  // StartMySQLExplainTraditionalJSONAction starts MySQL EXPLAIN Action with traditional JSON output.
  rpc StartMySQLExplainTraditionalJSONAction(StartMySQLExplainTraditionalJSONActionRequest) returns (StartMySQLExplainTraditionalJSONActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartMySQLExplainTraditionalJSON"
      body: "*"
    };
  }
  // StartMySQLShowCreateTableAction starts MySQL SHOW CREATE TABLE Action.
  rpc StartMySQLShowCreateTableAction(StartMySQLShowCreateTableActionRequest) returns (StartMySQLShowCreateTableActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartMySQLShowCreateTable"
      body: "*"
    };
  }
  // StartMySQLShowTableStatusAction starts MySQL SHOW TABLE STATUS Action.
  rpc StartMySQLShowTableStatusAction(StartMySQLShowTableStatusActionRequest) returns (StartMySQLShowTableStatusActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartMySQLShowTableStatus"
      body: "*"
    };
  }
  // StartMySQLShowIndexAction starts MySQL SHOW INDEX Action.
  rpc StartMySQLShowIndexAction(StartMySQLShowIndexActionRequest) returns (StartMySQLShowIndexActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartMySQLShowIndex"
      body: "*"
    };
  }
  // StartPostgreSQLShowCreateTableAction starts PostgreSQL SHOW CREATE TABLE Action.
  rpc StartPostgreSQLShowCreateTableAction(StartPostgreSQLShowCreateTableActionRequest) returns (StartPostgreSQLShowCreateTableActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartPostgreSQLShowCreateTable"
      body: "*"
    };
  }
  // StartPostgreSQLShowIndexAction starts PostgreSQL SHOW INDEX Action.
  rpc StartPostgreSQLShowIndexAction(StartPostgreSQLShowIndexActionRequest) returns (StartPostgreSQLShowIndexActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/StartPostgreSQLShowIndex"
      body: "*"
    };
  }
  // CancelAction stops an Action.
  rpc CancelAction(CancelActionRequest) returns (CancelActionResponse) {
    option (google.api.http) = {
      post: "/v0/management/Actions/Cancel"
      body: "*"
    };
  }
}
