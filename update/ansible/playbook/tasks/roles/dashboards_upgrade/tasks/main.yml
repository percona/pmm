---
- name: Get plugin list
  register: plugin_list
  find:
    paths: /usr/share/percona-dashboards/panels/
    depth: 2
    file_type: directory

- name: Delete redundant dist folders
  file:
    path: "/srv/grafana/plugins/{{ item['path'].split('/')[-1] }}"
    state: absent
  loop: "{{ plugin_list['files'] }}"

- name: Copy plugins to the plugin directory
  synchronize:
    src: /usr/share/percona-dashboards/panels/
    dest: /srv/grafana/plugins/

- name: Set permissions for the plugin directory
  file:
    path: "/srv/grafana/plugins"
    state: directory
    owner: pmm
    group: pmm
    mode: 0775
    recurse: yes

- name: Restart grafana with new plugins EL9
  supervisorctl:
    name: grafana
    state: restarted
  become: true
  when: 
    - ansible_distribution == 'OracleLinux' or ansible_distribution == 'AlmaLinux'
    - ansible_distribution_major_version == '9'
  ignore_errors: true
  # TODO: fix the race condition.
  # We generate grafana supervisor config in pmm-managed and it may not exist at this stage
