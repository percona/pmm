#!/bin/bash

. $(dirname $0)/vars

prepare_tarball() {
  local repo_name=$1
  local commit=$2
  local repo_url=$3
  local git_dir=
  local repo_var=$(
    echo "${repo_name}_commit" | sed -e 's:-:_:g' | tr '[[:lower:]]' '[[:upper:]]'
  )
  local tarball=${source_dir}/${repo_name}-${commit::7}.tar.gz

  if [ -z "$commit" ]; then
    git_dir=$(dirname $(find "${root_dir}/sources/${repo_name}" -name .git | head -1))
    commit=$(git -C "${git_dir}" rev-parse --short HEAD)
    tarball=${source_dir}/${repo_name}-${commit}.tar.gz
  fi

  echo "${repo_var}=${commit::7}" >> ${client_properties}

  if [ -f "${tarball}" ]; then
    echo "Info: ${tarball} already exists, skip creating the tarball..."
    return
  fi

  if [ -n "$repo_url" ]; then
    curl -o ${tarball} -fsSL ${repo_url}/archive/${commit}.tar.gz
    return
  fi

  git -C "${git_dir}" archive \
      --format=tar.gz \
      --prefix=${repo_name}-${commit}/ \
      -o ${tarball} \
      "${commit}"
}

main() {
  echo -----------------------------------------
  echo "Building PMM Client source files..."
  echo -----------------------------------------

  rm -rf ${source_tarball}
  mkdir -p ${source_dir}/ $(dirname ${source_tarball}) || :

  prepare_tarball vmagent ${vmagent_commit_hash} https://github.com/VictoriaMetrics/VictoriaMetrics
  prepare_tarball nomad ${nomad_commit_hash} https://github.com/hashicorp/nomad
  prepare_tarball pmm
  prepare_tarball mongodb_exporter
  prepare_tarball mysqld_exporter
  prepare_tarball postgres_exporter
  prepare_tarball proxysql_exporter
  prepare_tarball node_exporter
  prepare_tarball rds_exporter
  prepare_tarball azure_metrics_exporter
  prepare_tarball percona-toolkit

  local noxattrs=
  if echo $(uname -s) | grep -qi "Darwin"; then
    noxattrs="--no-xattrs"
  fi

  tar -C $(dirname ${source_dir}) ${noxattrs} -zcpf ${source_tarball} $(basename ${source_dir})
}

main

# vim: expandtab shiftwidth=2 tabstop=2
