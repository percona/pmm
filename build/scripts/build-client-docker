#!/bin/bash

. $(dirname $0)/vars

main() {
  echo -----------------------------------------
  echo "Building docker image for PMM Client..."
  echo -----------------------------------------

  local DOCKER_CONTEXT_DIR="${build_dir}/docker"
  local DOCKERFILE_DIR="${pmm_build_dir}/docker/client"
  local BUILD_DATE=$(date -u +'%F %T%z' | sed 's@^.\{22\}@&:@')
  
  mkdir -p "$DOCKER_CONTEXT_DIR"
  cp "${build_dir}"/tarball/pmm-client-*.tar.gz "${DOCKER_CONTEXT_DIR}/pmm-client.tar.gz"
  cp "$DOCKERFILE_DIR/"* "${DOCKER_CONTEXT_DIR}"

  if [ -z "${DOCKER_CLIENT_TAG}" ]; then
    DOCKER_CLIENT_TAG="perconalab/pmm-client-fb:${shortcommit}"
  fi

  CLIENT_IMAGE_VERSION=`echo $DOCKER_CLIENT_TAG | cut -d ':' -f2`

  docker buildx build \
    --build-arg BUILD_DATE="$BUILD_DATE" \
    --build-arg VERSION="$CLIENT_IMAGE_VERSION" \
    --progress plain \
    -f ${DOCKER_CONTEXT_DIR}/${docker_file} \
    -t ${DOCKER_CLIENT_TAG} \
    ${DOCKER_CONTEXT_DIR}

  echo -n ${DOCKER_CLIENT_TAG} > ${docker_client_tag_file}
  rm -f "${DOCKER_CONTEXT_DIR}/pmm-client.tar.gz"

  echo
  echo "Finished building PMM Client docker image: $DOCKER_CLIENT_TAG"
  echo  
}

main

# vim: expandtab shiftwidth=2 tabstop=2
