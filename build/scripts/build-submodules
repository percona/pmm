#!/bin/bash
set -o errexit

if [ -s ci.yml ]; then
    if [ -f /home/ec2-user/venv/bin/activate ]; then
        source /home/ec2-user/venv/bin/activate
    fi
    python3 ci.py
    cat .git-sources
    . ./.git-sources
else
    # Define variables
    pmm_commit=$(git -C $(git config -f .gitmodules submodule.pmm.path) rev-parse HEAD)
    pmm_branch=$(git config -f .gitmodules submodule.pmm.branch)
    pmm_url=$(git config -f .gitmodules submodule.pmm.url)
    pmm_qa_branch=$(git config -f .gitmodules submodule.pmm-qa.branch)
    pmm_qa_commit=$(git -C $(git config -f .gitmodules submodule.pmm-qa.path) rev-parse HEAD)
    pmm_ui_tests_branch=$(git config -f .gitmodules submodule.pmm-ui-tests.branch)
    pmm_ui_tests_commit=$(git -C $(git config -f .gitmodules submodule.pmm-ui-tests.path) rev-parse HEAD)
fi

fb_commit_sha=$(git rev-parse HEAD)
echo $fb_commit_sha > fbCommitSha
echo $pmm_commit > apiCommitSha
echo $pmm_branch > apiBranch
echo $pmm_url > apiURL
echo $pmm_qa_branch > pmmQABranch
echo $pmm_qa_commit > pmmQACommitSha
echo $pmm_ui_tests_branch > pmmUITestBranch
echo $pmm_ui_tests_commit > pmmUITestsCommitSha
