- name: Start Docker service
  service:
    name: docker
    state: started
    enabled: yes

- name: pull the PMM image
  docker_image:
    name: "{{ pmm_server_image_name }}"
    source: pull

- name: get srv directory path
  shell: docker image inspect {{ pmm_server_image_name }} | jq -r .[0].GraphDriver.Data.UpperDir
  register: image_path

- name:
  copy:
    src: "{{ image_path.stdout }}/srv/"
    dest: /srv/
    mode: preserve
    remote_src: yes

- name: Copy content of 'srv' directory from image
  synchronize:
    src: "{{ image_path.stdout }}/srv/"
    dest:  /srv/
    recursive: yes
  delegate_to: "{{ inventory_hostname }}"

- name: Set AMI distribution
  copy:
    content: |
      ami
    dest: /srv/pmm-distribution

- name: Copy systemd service file to image
  template:
    src: pmm2.service
    dest: /etc/systemd/system
    owner: root
    group: root

- name: Enable PMM2 container
  systemd:
    name: pmm2
    enabled: yes