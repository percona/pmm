#!/bin/sh

expire_limit=30 # days

expire_data=`openssl x509 -enddate -noout -in /srv/nginx/certificate.crt | sed -e 's#notAfter=##'`
expire_date=`date -d "${expire_data}" '+%s'`
current_date=`date '+%s'`
diff="$((${expire_date}-${current_date}))"

echo $diff

if test "${diff}" -lt "$((${expire_limit}*24*3600))"; then
    # Check if we can write to /etc/nginx/ssl/ directory
    if [ -w "/etc/nginx/ssl" ]; then
        # Standard path: generate in /etc/nginx/ssl/ and copy to /srv/nginx/
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /etc/nginx/ssl/certificate.key \
            -out    /etc/nginx/ssl/certificate.crt \
            -config /etc/nginx/ssl/certificate.conf
        cp /etc/nginx/ssl/certificate.key /srv/nginx/certificate.key
        cp /etc/nginx/ssl/certificate.crt /srv/nginx/certificate.crt
    else
        # OpenShift/arbitrary UID path: generate directly in /srv/nginx/
        echo "Cannot write to /etc/nginx/ssl/, generating certificates directly in /srv/nginx/"
        # Copy certificate.conf to /srv/nginx/ for openssl to use
        cp /etc/nginx/ssl/certificate.conf /srv/nginx/certificate.conf
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /srv/nginx/certificate.key \
            -out    /srv/nginx/certificate.crt \
            -config /srv/nginx/certificate.conf
    fi
    
    # Set proper permissions for OpenShift compatibility  
    chmod 640 /srv/nginx/certificate.crt
    chmod 640 /srv/nginx/certificate.key
fi
