---
# This role installs pmm-client.
- name: Get the image version
  slurp:
    src: /usr/share/percona-dashboards/VERSION
  register: image_version_file

- name: Set the PMM image version
  set_fact:
    pmm_image_version: "{{ image_version_file['content'] | b64decode | trim }}"

- name: Create an empty directory for the tarball
  file:
    path: /tmp/pmm-client
    state: directory

- name: Unpack the tarball
  unarchive:
    src: /tmp/pmm2-client.tar.gz
    dest: /tmp/
    remote_src: true

- name: Create a directory for pmm-client
  file: 
    path: /usr/local/percona/pmm2
    state: directory 
    owner: pmm 
    group: pmm 
    mode: 0755

- name: Install the client
  command: env PMM_USER=pmm PMM_GROUP=pmm /tmp/pmm2-client-{{ pmm_image_version }}/install_tarball

- name: Remove the tarball
  file:
    path: /tmp/pmm2-client.tar.gz
    state: absent

- name: Remove the binary
  file:
    path: /tmp/pmm2-client-{{ pmm_image_version }}
    state: absent
