---
- name: Install supervisor
  pip:
    name: supervisor==4.2.4

- name: Create a symlink for supervisord
  file:
    src: /usr/local/bin/supervisord
    dest: /usr/bin/supervisord
    state: link

- name: Create a default configuration file for supervisord
  command: /usr/local/bin/echo_supervisord_conf > /etc/supervisord.conf

- name: Modify supervisord.conf
  ini_file:
    dest: /etc/supervisord.conf
    section: include
    option: files
    value: supervisord.d/*.ini

- name: Modify supervisord.conf
  ini_file:
    dest: /etc/supervisord.conf
    section: unix_http_server
    option: file
    value: /run/supervisor/supervisor.sock

- name: Modify supervisord.conf
  ini_file:
    dest: /etc/supervisord.conf
    section: supervisord
    option: logfile
    value: /srv/logs/supervisord.log

- name: Modify supervisord.conf
  ini_file:
    dest: /etc/supervisord.conf
    section: supervisord
    option: pidfile
    value: /run/supervisord.pid

- name: Modify supervisord.conf
  ini_file:
    dest: /etc/supervisord.conf
    section: supervisorctl
    option: serverurl
    value: unix:///run/supervisor/supervisor.sock

- name: Create a directory for socket
  file:
    path: /run/supervisor
    state: directory
    owner: pmm
    group: pmm
    mode: 0770

- name: Create /etc/supervisord.d dir
  file:
    path: /etc/supervisord.d
    state: directory
    mode: 0755

- name: Copy *.ini files for PMM components
  copy:
    src: "{{ item }}"
    dest: "/etc/supervisord.d/{{ item }}"
    owner: pmm
    group: pmm
    mode: 0644
  loop:
    - supervisord.ini
    - grafana.ini
    - pmm.ini

- name: Add /etc/tmpfiles.d/supervisor.conf config
  when: ansible_virtualization_type != "docker"
  copy:
    content: |
      D /var/run/supervisor 0775 root root -
    dest: /etc/tmpfiles.d/supervisor.conf
    mode: 0644

- name: Fix credentials
  ini_file:
    dest: /etc/supervisord.conf
    section: supervisorctl
    option: username
    value: dummy

- name: Fix credentials
  ini_file:
    dest: /etc/supervisord.conf
    section: supervisorctl
    option: password
    value: dummy

- name: Increase the number of open files for jobs
  when: ansible_virtualization_type != "docker"
  ini_file:
    dest: /etc/supervisord.conf
    section: supervisord
    option: minfds
    value: "800000"

- name: Add supervisord.service
  when: ansible_virtualization_type != "docker"
  copy:
    src: supervisord.service
    dest: /usr/lib/systemd/system/
    mode: 0644

- name: Fix motd
  shell: echo "Welcome to PMM Server!" > /etc/motd; echo "Welcome to PMM Server!" > /etc/motd.conf

- name: Print the contents of supervisord.conf
  debug:
    msg:
      - "{{ lookup('file', '/etc/supervisord.conf') | split('\n') }}"
