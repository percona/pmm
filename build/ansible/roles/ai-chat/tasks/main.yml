---
# Main tasks for AI Chat Backend service
- name: Include variables
  include_vars: ../vars/main.yml

# Install uv for MCP servers
- name: Check if uv is installed
  command: uv --version
  register: uv_version
  ignore_errors: yes

- name: Install uv Python package manager
  shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  become: true
  become_method: su
  become_user: pmm
  when: uv_version.rc != 0

- name: Add uv to PATH for all users
  lineinfile:
    path: /home/pmm/.profile
    line: 'export PATH="/home/pmm/.cargo/bin:$PATH"'
    create: yes
    state: present
    owner: pmm
    group: pmm
    mode: '0644'
  when: uv_version.rc != 0

- name: Create aichat-backend directories
  file:
    path: "{{ item }}"
    state: directory
    owner: pmm
    group: pmm
    mode: '0755'
  loop:
    - /srv/aichat-backend
    - /srv/logs

- name: Copy aichat-backend binary
  copy:
    src: aichat-backend
    dest: /usr/local/bin/aichat-backend
    owner: root
    group: root
    mode: '0755'
  notify: restart aichat-backend

- name: Create aichat-backend log file
  file:
    path: /srv/logs/aichat-backend.log
    state: touch
    owner: pmm
    group: pmm
    mode: '0644'

- name: Deploy supervisord configuration for aichat-backend
  copy:
    src: ai-chat.ini
    dest: /etc/supervisord.d/ai-chat.ini
    owner: root
    group: root
    mode: '0644'
  notify: restart supervisord

- name: Ensure aichat-backend service is started
  supervisorctl:
    name: aichat-backend
    state: started
  become: yes