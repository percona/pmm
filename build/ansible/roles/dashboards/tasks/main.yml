---
- name: Stop Grafana
  shell: supervisorctl stop grafana
  become: true
  become_user: pmm
  become_method: su
  retries: 3
  delay: 10
  until: result.rc == 0

- name: Remove Grafana from Supervisor jobs
  shell: supervisorctl remove grafana
  become: true
  become_user: pmm
  become_method: su
  retries: 3
  delay: 10
  until: result.rc == 0  

- name: Retrieve Percona plugins
  find:
    paths: /usr/share/percona-dashboards/panels/
    depth: 2
    file_type: directory
  register: plugin_list

- name: Delete outdated plugins
  file:
    path: "/srv/grafana/plugins/{{ item['path'].split('/')[-1] }}"
    state: absent
  loop: "{{ plugin_list['files'] }}"

- name: Copy new plugins to the plugin directory
  synchronize:
    src: /usr/share/percona-dashboards/panels/
    dest: /srv/grafana/plugins/

- name: Set permissions for the plugin directory
  file:
    path: /srv/grafana/plugins
    state: directory
    owner: pmm
    group: pmm
    mode: 0775
    recurse: yes

- name: Synchronize Percona Dashboards version file after upgrade
  copy:
    src: /usr/share/percona-dashboards/VERSION
    dest: /srv/grafana/PERCONA_DASHBOARDS_VERSION
    owner: pmm
    group: pmm
    mode: 0644
    remote_src: yes    

- name: Restart Grafana service with new plugins 
  shell: "supervisorctl {{ item }} grafana"
  become: true
  become_user: pmm
  become_method: su
  loop:
    - add
