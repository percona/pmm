---
- name: Retrieve Percona plugins
  find:
    paths: /usr/share/percona-dashboards/panels/
    depth: 2
    file_type: directory
  register: plugin_list

- name: Delete outdated plugins
  file:
    path: "/srv/grafana/plugins/{{ item['path'].split('/')[-1] }}"
    state: absent
  loop: "{{ plugin_list['files'] }}"

- name: Copy new plugins to the plugin directory
  synchronize:
    src: /usr/share/percona-dashboards/panels/
    dest: /srv/grafana/plugins/

- name: Set permissions for the plugin directory
  file:
    path: /srv/grafana/plugins
    state: directory
    mode: 0775
    recurse: yes

- name: Synchronize Percona Dashboards version file after upgrade
  copy:
    src: /usr/share/percona-dashboards/VERSION
    dest: /srv/grafana/PERCONA_DASHBOARDS_VERSION
    mode: 0664
    remote_src: yes

- name: Restart Grafana service with new plugins 
  shell: "supervisorctl {{ item }} grafana"
  loop:
    - stop
    - remove
    - add
