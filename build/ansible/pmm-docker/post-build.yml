---
# This playbook runs post build tasks for all pmm distributions (AMI/OVF/Docker/Digitalocean).

- hosts: all
  become: yes
  gather_facts: yes
  vars:
    pmm_server_distribution: "docker"

  tasks:
    - name: Set up pmm-agent
      command: >
        pmm-agent setup
        --config-file=/usr/local/percona/pmm/config/pmm-agent.yaml
        --skip-registration
        --id=pmm-server
        --server-address=127.0.0.1:8443
        --server-insecure-tls

    - name: Cleanup dnf cache
      command: dnf clean all

    # "yum clean all" function will only remove cache from configured yum repositories
    # Details: https://bugzilla.redhat.com/show_bug.cgi?id=1357083
    - name: Cleanup dnf cache
      file:
        state: absent
        path: /var/cache/dnf

    - name: Cleanup build logs and data
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /srv/logs
        - /var/log/dnf.log
        - /var/log/secure
        - /var/log/wtmp
        - /var/log/clickhouse-server
        - /var/log/nginx
        - /var/lib/pgsql
        - /srv/pmm-encryption.key
        - /var/cache/yum

    - name: Remove users created by installers
      user:
        name: "{{ item }}"
        state: absent
      loop:
        - postgres
        - clickhouse
        - nginx

    - name: Clean Clickhouse dir
      shell: find /srv/clickhouse -mindepth 1 -maxdepth 1 -print0 | xargs -0 rm -rf --
