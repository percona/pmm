---
# This playbook contains tasks executed during PMM Server update in non-docker environments.
# TODO: refactor from supervisord to systemd if necessary.
- hosts: all
  become: true
  remote_user: root
  gather_facts: true

  # TODO: replace supervisord.service with pmm.service
  tasks:
    # Note: forking type must be set to 'simple'
    - name: Configure systemd
      copy:
        src: supervisord.service
        dest: /usr/lib/systemd/system/supervisord.service
        mode: 0644

    # Start the services
    - name: Enable supervisord service to persist between reboots
      systemd:
        name: supervisord
        enabled: yes

    - name: Start supervisord service for AMI/OVF
      systemd:
        name: supervisord
        state: started # supervisord may already be running
        daemon_reload: yes

    - name: Enable crond service
      service:
        name: crond
        state: started
        enabled: yes

    # https://jira.percona.com/browse/PMM-9298
    - name: Copy rezise-xfs file for lvm
      copy:
        src: resize-xfs-lvm
        dest: /var/lib/cloud/scripts/per-boot/resize-xfs
        mode: 0755
        force: true
