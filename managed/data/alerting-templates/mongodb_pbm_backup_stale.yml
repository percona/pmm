---
templates:
  - name: pmm_mongodb_pbm_backup_stale
    version: 1
    summary: PBM Backup Stale
    expr: |-
      (
        time() - max by (cluster, replica_set) (
          max_over_time(
            mongodb_pbm_backup_last_transition_ts{status="done"}[30d]
          )
        )
      ) > [[ .threshold ]]
    params:
      - name: threshold
        summary: Maximum allowed age of last successful backup (seconds, defaults to 24h)
        type: float
        range: [0, 2678400]
        value: 86400
    for: 1m
    severity: critical
    annotations:
      summary: Last PBM backup is stale for cluster={{ $labels.cluster }}, replica_set={{ $labels.replica_set }}
      description: |-
        Last PBM backup is stale for cluster={{ $labels.cluster }}, replica_set={{ $labels.replica_set }}
        Age: {{ $value | humanizeDuration }} (exceeds [[ .threshold ]] seconds).
        