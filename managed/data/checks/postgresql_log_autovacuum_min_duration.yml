---
checks:
  - version: 2
    name: postgresql_log_autovacuum_min_duration
    summary: PostgreSQL Autovacuum Logging Is Disabled
    description: This check returns a notice if the log_autovacuum_min_duration configuration option is set to -1 (disabled). It is recommended to enable the logging of autovacuum run information, as that provides a lot of useful information with almost no drawbacks.
    family: POSTGRESQL
    #author: Sergey Kuzmichev
    advisor: configuration_vacuum
    interval: standard
    queries:
      - type: POSTGRESQL_SELECT
        query: name, setting FROM pg_settings WHERE name = 'log_autovacuum_min_duration'
    script: |
      read_url = "https://docs.percona.com/percona-platform/advisors/checks/{}.html"

      # pg_advisor
      def check_context(docs, context):
          for row in docs[0]:
              name, setting = row["name"], row["setting"]
              if name == "log_autovacuum_min_duration":
                  val = int(setting)

          results = []
          if val == -1:
              results.append({
                  "summary": "The current value of log_autovacuum_min_duration is -1",
                  "description": "Logging of autovacuum run information is currently disabled. It is recommended to enable the logging of autovacuum run information, as that provides a lot of useful information with almost no drawbacks.",
                  "read_more_url": read_url.format("configuration-pg-log-autovacuum-disabled"),
                  "severity": "notice"
              })

          return results
