---
checks:
  - version: 2
    name: mysql_configuration_innodb_file_format
    summary: MySQL InnoDB file format
    description: Check if InnoDB is configured with recommended file format
    interval: standard
    advisor: configuration_innodb
    #author: The Grinch
    family: MYSQL
    queries:
      - type: MYSQL_SELECT
        query: " @@version version,@@hostname service, VARIABLE_NAME as name, VARIABLE_VALUE as value from performance_schema.global_variables where VARIABLE_NAME in ('innodb_file_format','innodb_file_format_max');"
    script: |
      def check_innodb_conf(doc,read_url):
          for row in doc:
            version = row["version"]
            service = row["service"]
            name = row["name"]
            value = row["value"]

            if name == "innodb_file_format" and value != "Barracuda" :
               return {
                 "summary": "InnoDB File Format is not optimal",
                 "description": "InnoDB is using the old file format insted of the new Barracuda. Current setting: {} = {} ;".format(name,value),
                 "severity": "notice",
                 "read_more_url": read_url.format("configuration-innodb-file-format"),
                 "labels": {
                    "mysql_version": "{}".format(version),
                     "service": "{}".format(service),
                    }
               }

            if name == "innodb_file_format_max" and value != "Barracuda" :
               return {
                 "summary": "InnoDB File Format Max is not optimal",
                 "description": "InnoDB is using the old file format insted of the new Barracuda. Current setting: {} = {} ;".format(name,value),
                 "severity": "notice",
                 "read_more_url": read_url.format("configuration-innodb-file-format"),
                 "labels": {
                    "mysql_version": "{}".format(version),
                     "service": "{}".format(service),
                    }
               }

      def check_context(docs, context):
          # we first define some global variables
          read_url = "https://docs.percona.com/percona-platform/advisors/checks/{}.html"
          results = []

          result1 = check_innodb_conf(docs[0],read_url)
          if result1:
            results.append(result1)

          return results
