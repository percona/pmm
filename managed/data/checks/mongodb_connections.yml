---
checks:
  - version: 2
    name: mongodb_connections
    summary: MongoDB High connections
    description: This check returns the current number of connections as an informational notice when connection counts are above 5000.
    interval: standard
    family: MONGODB
    advisor: configuration_connection
    #category: configuration
    #subcategory: connection configuration
    #author: Parag Bhayani
    queries:
      - type: MONGODB_GETDIAGNOSTICDATA
    script: |
      read_url = "https://docs.percona.com/percona-platform/advisors/checks/{}.html"

      def check(docs):
          # for compatibility with PMM Server < 2.12
          context = {
              "format_version_num": format_version_num,
              "parse_version": parse_version,
          }
          return check_context(docs, context)

      def check_context(docs, context):
          """
          This check returns a notice if the number of connections is above a default threshold - currently set to 5000. While not necessarily a high number, it can highlight potential configuration issues with connection or driver settings that may lead to increased memory usage if unintended.
          """

          format_version_num = context.get("format_version_num", fail)
          parse_version = context.get("parse_version", fail)

          info = docs[0]
          results = []

          for row in info:
              # Checking no. of connections
              connections = row["data"]["serverStatus"]["connections"]["current"]
              host = row["data"]["serverStatus"]["host"]
              if connections > 5000:
                  results.append({
                      "summary": "The current number of connections for this MongoDB node are - {} ".format(connections),
                      "description": "Please confirm your desired driver and connection settings. You can use mongostat and the currentOp command to see what operations the connections are running. For more information please check the Read More documentation.",
                      "read_more_url": read_url.format("mongo-high-connections"),
                      "severity": "notice",
                  })
              return results
