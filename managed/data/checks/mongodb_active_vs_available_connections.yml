---
### MongoDB Platform Advisors Active vs Available Connections
checks:
  - version: 1
    name: mongodb_active_vs_available_connections
    summary: MongoDB Active vs Available Connections
    description: This check returns warnings if the ratio between active and available connections is higher than 75%
    type: MONGODB_GETDIAGNOSTICDATA
    #family: mongodb
    #author: Corrado Pandiani
    advisor: configuration_generic
    interval: standard
    script: |
      def check(docs):
          # for compatibility with PMM Server < 2.12
          context = {
              "format_version_num": format_version_num,
              "parse_version": parse_version,
          }
          return check_context(docs, context)

      def check_context(docs, context):
          """
          This check returns warnings if number of active connections is too high.
          """

          if len(docs) != 1:
              return "Unexpected number of documents"

          results = []

          data = docs[0]["data"]
          active_connections = data.get("serverStatus").get("connections").get("active")
          available_connections = data.get("serverStatus").get("connections").get("available")
          ratio = 100*active_connections/(active_connections+available_connections)

          if ratio >= 75:
              results.append({
                  "summary": "MongoDB has too many active connections",
                  "description": "More than 75% of available connections are active. You may increase the available connections by increasing the ULIMIT. You can also check the workload, maybe there's unexpected spike of connections and queries.",
                  "read_more_url": "https://www.mongodb.com/docs/manual/reference/ulimit/#recommended-settings",
                  "severity": "warning",
              })

          return results
