---
checks:
  - version: 1
    name: postgresql_log_checkpoints_1
    summary: PostgreSQL Checkpoints Logging is Disabled.
    description: This check returns a notice if the log_checkpoints configuration option is not enabled. It is recommended to enable the logging of checkpoint information, as that provides a lot of useful information with almost no drawbacks.
    type: POSTGRESQL_SELECT
    #family: postgresql
    #author: Sergey Kuzmichev
    advisor: configuration_generic
    interval: standard
    query: name, setting FROM pg_settings WHERE name = 'log_checkpoints'
    script: |
      read_url = "https://docs.percona.com/percona-platform/advisors/checks/{}.html"

      # pg_advisor
      def check(rows):
          # for compatibility with PMM Server < 2.12
          context = {
              "format_version_num": format_version_num,
              "parse_version": parse_version,
          }
          return check_context(rows, context)

      def check_context(rows, context):
          for row in rows:
              name, setting = row["name"], row["setting"]
              if name == "log_checkpoints":
                  val = setting
          results = []
          if val == "off":
              results.append({
                  "summary": "The current value of log_checkpoints is off",
                  "description": "Logging of checkpoint information is currently disabled. It is recommended to enable the logging of checkpoint information, as that provides a lot of useful information with almost no drawbacks.",
                  "read_more_url": read_url.format("configuration-pg-log-checkpoints-disabled"),
                  "severity": "notice"
              })
          return results
