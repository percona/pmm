---
checks:
  - version: 2
    name: mongodb_auth
    summary: MongoDB authentication
    description: Warns if MongoDB authentication is disabled.
    family: MONGODB
    advisor: security_authentication
    interval: standard
    queries:
      - type: MONGODB_GETCMDLINEOPTS
    script: |
      def check_context(docs, context):
          """
          This check returns warnings if MongoDB authentication is disabled.
          """

          rows = docs[0]
          if len(rows) != 1:
              return "Unexpected number of documents"

          results = []

          parsed = rows[0]["parsed"]
          print(repr(parsed))

          security = parsed.get("security", {})
          auth_enabled = (security.get("authorization") == "enabled")
          auth_enabled = auth_enabled or ("keyFile" in security)
          auth_enabled = auth_enabled or ("clusterAuthMode" in security)

          if not auth_enabled:
              results.append({
                  "summary": "MongoDB authentication is disabled",
                  "description": "See the following for steps to enable",
                  "read_more_url": "https://docs.mongodb.com/manual/tutorial/enable-authentication/",
                  "severity": "warning",
              })

          return results
