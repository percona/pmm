---
checks:
  - version: 1
    name: mysql_automatic_expired_password
    summary: MySQL Automatic User Expired Password
    description: This check warns if MySQL parameter automatic password expiry is not active.
    type: MYSQL_SHOW
    #family: mysql
    advisor: security_authentication
    interval: standard
    query: VARIABLES
    script: |
      def check(rows):
          return check_context(rows, {})

      def check_context(rows, context):
          """
          This check returns a warning if automatic password expiry is not active.
          """

          summary = ""
          action = "activate"

          for row in rows:
              name, value = row["Variable_name"], row["Value"]
              if name == "default_password_lifetime":
                  print(name, "=", value)
                  if value == "0":
                      summary = "Automatic password expiry is not active. "
                  elif value >= "365":
                      summary = "Default password lifetime is too long. It's set to {} days. ".format(value)
                      action = "change"

              if name == "disconnect_on_expired_password" and summary:
                  print(name, "=", value)
                  if value == "ON":
                      summary = summary + "System variable disconnect_on_expired_password is enabled. The server will not allow connecting clients with expired passwords."
                  else:
                      summary = summary + "System variable disconnect_on_expired_password is disabled. The server permits the client to connect but puts it in sandbox mode."

          if summary:
              return [{
                          "summary": summary,
                          "description": "See the following steps to {} ".format(action),
                          "read_more_url": "https://dev.mysql.com/doc/refman/8.0/en/password-management.html#password-expiration-policy",
                          "severity": "warning"
              }]

          return []
