---
checks:
  - version: 2
    name: mysql_log_replica_updates
    summary: MySQL configuration check
    description: Checks if a replica is safely logging replicated transactions.
    interval: standard
    family: MYSQL
    advisor: configuration_replication
    #author: tibi/the grinch
    queries:
      - type: MYSQL_SHOW
        query: VARIABLES
    script: |
      def check_context(docs, context):
          # `docs` is a frozen (deeply immutable) list where each item represents single query results. The order of results
          # matches the order of queries in the check file. Each query result is list of dicts where where each dict represents
          # a single document in the result set.
          #
          # `context` is a dict with additional functions.
          #
          # Global `print` and `fail` functions are available.
          #
          # `check_context` function is expected to return a list of dicts that are then converted to alerts;
          # in particular, that list can be empty.
          # Any other value (for example, string) is treated as script execution failure
          # (Starlark does not support Python exceptions);
          # it is recommended to use global function `fail` for that instead.
           results = []
           read_url = "https://docs.percona.com/percona-platform/advisors/checks/{}.html"

           for row in docs[0]:
               name, value = row["Variable_name"], row["Value"]
               if name == "log_replica_updates" or name == "log_slave_updates":
                if value == "OFF":
                   results.append({
                       "summary": "MySQL server updates received by a replica server from a replication source server are not logged to the replica's own binary log.",
                       "description": "MySQL server replicating events are not logged.",
                       "read_more_url":read_url.format("mysql-log-replica-updates"),
                       "severity": "warning",
                       "labels": {},
                   })
           return results
