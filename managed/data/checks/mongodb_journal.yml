---
### MongoDB Advisors - Journal Check
checks:
  - version: 2
    name: mongodb_journal
    summary: MongoDB Journal
    description: This check returns warnings if journal is disabled.
    family: MONGODB
    #author: Corrado Pandiani
    advisor: configuration_generic
    interval: standard
    queries:
      - type: MONGODB_GETCMDLINEOPTS
    script: |
      read_url = "https://docs.percona.com/percona-platform/advisors/checks/{}.html"

      def check_context(docs, context):
          """
          This check returns warnings if MongoDB journal is disabled.
          """

          rows = docs[0]
          if len(rows) != 1:
              return "Unexpected number of documents"

          results = []
          parsed = rows[0]["parsed"]
          print(repr(parsed))
          storage_journal = parsed.get("storage.journal", {})
          journal_enabled = (storage_journal.get("enabled") == "true")

          if not journal_enabled:
              results.append({
                  "summary": "MongoDB journaling is disabled",
                  "description": "Journaling should not be disabled on production systems. This presents a risk to data durability in the event of a failure. See the following for further details.",
                  "read_more_url": read_url.format("mongodb-journal"),
                  "severity": "warning",
              })
          return results
